<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="5; url=https://linktr.ee/cefri" id="fallback-meta" />
    <title>CEFRI</title>
</head>
<body>
    <script>
        const metaRefresh = document.getElementById('fallback-meta').content;
        const fallbackUrl = metaRefresh.split('url=')[1];

        const CONFIG = {
            repoOwner: "cefri",
            repoName: "cefri.github.io",
            fallbackUrl: fallbackUrl, // Utilise l'URL extraite de la balise meta
            distanceTolerance: 3
        };

        function calculerDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        async function initRedirection() {
            const path = window.location.pathname.replace(/\/$/, "");
            const segment = path.split("/").pop() || "";
            const urlSaisieNettoyee = decodeURIComponent(segment).replace(/\.[a-z0-9]+$/i, "");
            
            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.repoOwner}/${CONFIG.repoName}/contents/`);
                if (!response.ok) throw new Error("Erreur API GitHub");

                const fichiers = await response.json();
                const pagesExistantes = fichiers
                    .filter(f => f.type === "file" && f.name.toLowerCase().endsWith(".html"))
                    .map(f => f.name);

                let meilleureCorrespondance = null;
                let distanceMinimale = CONFIG.distanceTolerance;

                pagesExistantes.forEach(page => {
                    const nomPageNettoye = page.replace(/\.[a-z0-9]+$/i, "");
                    const distance = calculerDistance(urlSaisieNettoyee.toLowerCase(), nomPageNettoye.toLowerCase());
                    if (distance < distanceMinimale) {
                        distanceMinimale = distance;
                        meilleureCorrespondance = page;
                    }
                });

                if (meilleureCorrespondance) {
                    window.location.replace("/" + meilleureCorrespondance);
                } else {
                    window.location.replace(CONFIG.fallbackUrl);
                }
            } catch (error) {
                window.location.replace(CONFIG.fallbackUrl);
            }
        }

        initRedirection();
    </script>
</body>
</html>
